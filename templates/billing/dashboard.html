{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Jewellery Billing System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Top Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex align-items-center gap-4">
                <div>
                    <h3 id="current-time" class="mb-0"></h3>
                    <small class="text-muted" id="current-date"></small>
                </div>
                <div class="vr"></div>
                <div class="d-flex align-items-center gap-2 bg-white p-3 rounded shadow-sm">
                    <i class="fas fa-coins text-warning fa-lg"></i>
                    <label class="mb-0 me-2">Gold (24K): ₹</label>
                    <input type="text" id="gold-rate-input" value="{{ gold_rate.rate_24k|default:'0.00' }}" 
                           class="form-control form-control-sm d-inline-block" style="width: 120px;">
                    <span class="text-muted">/gm</span>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="updateGoldRate()">
                        <i class="fas fa-save"></i>
                    </button>
                </div>
                <div class="d-flex align-items-center gap-2 bg-white p-3 rounded shadow-sm">
                    <i class="fas fa-coins text-secondary fa-lg"></i>
                    <label class="mb-0 me-2">Silver: ₹</label>
                    <input type="text" id="silver-rate-input" value="{{ silver_rate.rate_per_gram|default:'0.00' }}" 
                           class="form-control form-control-sm d-inline-block" style="width: 120px;">
                    <span class="text-muted">/gm</span>
                    <button class="btn btn-sm btn-outline-secondary ms-2" onclick="updateSilverRate()">
                        <i class="fas fa-save"></i>
                    </button>
                </div>
                <div class="d-flex align-items-center gap-2 bg-white p-3 rounded shadow-sm">
                    <i class="fas fa-cube text-info fa-lg"></i>
                    <label class="mb-0 me-2">Bar: ₹</label>
                    <input type="text" id="bar-rate-input" value="{% if bar_rate %}{{ bar_rate.rate_per_gram|default:'0.00' }}{% else %}0.00{% endif %}" 
                           class="form-control form-control-sm d-inline-block" style="width: 120px;">
                    <span class="text-muted">/pc</span>
                    <button class="btn btn-sm btn-outline-info ms-2" onclick="updateBarRate()">
                        <i class="fas fa-save"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-12 text-end">
            <a href="{% url 'bill_create' %}" class="btn btn-success">
                <i class="fas fa-receipt me-2"></i>New Bill
            </a>
            <a href="{% url 'bill_list' %}" class="btn btn-outline-primary">
                <i class="fas fa-file-invoice me-2"></i>View Bills
            </a>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title mb-0">Today's Total Sales</h6>
                        <div class="bg-success bg-opacity-25 rounded-circle p-2">
                            <i class="fas fa-rupee-sign text-success"></i>
                        </div>
                    </div>
                    <h3 class="mb-0">₹ {{ today_total_sales|floatformat:2 }}</h3>
                    {% if sales_growth %}
                    <small class="text-success">
                        <i class="fas fa-arrow-up"></i> {{ sales_growth }}% from yesterday
                    </small>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title mb-0">Cash Received</h6>
                        <div class="bg-primary bg-opacity-25 rounded-circle p-2">
                            <i class="fas fa-money-bill-wave text-primary"></i>
                        </div>
                    </div>
                    <h3 class="mb-0">₹ {{ today_cash_received|floatformat:2 }}</h3>
                    <small class="text-muted">
                        {{ cash_received_percentage }}% of total sales
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title mb-0">Gold Received</h6>
                        <div class="bg-warning bg-opacity-25 rounded-circle p-2">
                            <i class="fas fa-weight-scale text-warning"></i>
                        </div>
                    </div>
                    <h3 class="mb-0">{{ today_gold_received|floatformat:3 }} <small class="text-muted">gm</small></h3>
                    <small class="text-muted">Old gold exchange</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="card-title mb-0">Outstanding Balance</h6>
                        <div class="bg-danger bg-opacity-25 rounded-circle p-2">
                            <i class="fas fa-file-invoice-dollar text-danger"></i>
                        </div>
                    </div>
                    <h3 class="mb-0">₹ {{ outstanding_balance|floatformat:2 }}</h3>
                    <small class="text-danger">From {{ outstanding_count }} active bills</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Bills -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Recent Bills</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Bill No.</th>
                                    <th>Customer</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bill in recent_bills %}
                                <tr>
                                    <td><strong>{{ bill.bill_number }}</strong></td>
                                    <td>{{ bill.customer.name }}</td>
                                    <td>₹ {{ bill.net_payable|floatformat:2 }}</td>
                                    <td>
                                        {% if bill.status == 'paid' %}
                                        <span class="badge bg-success">Paid</span>
                                        {% elif bill.status == 'partial' %}
                                        <span class="badge bg-warning">Partial</span>
                                        {% else %}
                                        <span class="badge bg-danger">Unpaid</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ bill.bill_date|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        <a href="{% url 'bill_detail' bill.pk %}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i> View
                                        </a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted">No bills found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function updateTime() {
        const now = new Date();
        const timeEl = document.getElementById('current-time');
        const dateEl = document.getElementById('current-date');
        
        if (timeEl) {
            timeEl.textContent = now.toLocaleTimeString('en-US', { hour12: false });
        }
        if (dateEl) {
            dateEl.textContent = now.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }
    }
    
    setInterval(updateTime, 1000);
    updateTime();
    
    function updateGoldRate() {
        const rate = document.getElementById('gold-rate-input').value;
        if (!rate || parseFloat(rate) <= 0) {
            alert('Please enter a valid gold rate');
            return;
        }
        
        fetch('{% url "update_gold_rate" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'rate_24k=' + encodeURIComponent(rate)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Gold rate updated successfully!');
            } else {
                alert('Error: ' + (data.error || 'Failed to update gold rate'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating gold rate');
        });
    }
    
    function updateSilverRate() {
        const rate = document.getElementById('silver-rate-input').value;
        if (!rate || parseFloat(rate) <= 0) {
            alert('Please enter a valid silver rate');
            return;
        }
        
        fetch('{% url "update_silver_rate" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'rate_per_gram=' + encodeURIComponent(rate)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Silver rate updated successfully!');
            } else {
                alert('Error: ' + (data.error || 'Failed to update silver rate'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating silver rate');
        });
    }
    
    function updateBarRate() {
        const rate = document.getElementById('bar-rate-input').value;
        if (!rate || parseFloat(rate) <= 0) {
            alert('Please enter a valid bar rate');
            return;
        }
        
        fetch('{% url "update_bar_rate" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: 'rate_per_gram=' + encodeURIComponent(rate)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Bar rate updated successfully!');
            } else {
                alert('Error: ' + (data.error || 'Failed to update bar rate'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating bar rate');
        });
    }
</script>
{% endblock %}

